---
description: CORS policy and enforcement for Vesta HTTP apps
globs: apps/*/src/hooks*.ts, apps/*/src/index.ts, apps/*/src/**/api/**/*, packages/utils/src/**/cors*
---

# CORS Enforcement

All Vesta apps that expose HTTP endpoints **must** enforce CORS with strict origin allowlisting. See [Dependabot advisory #12](https://github.com/vesta-cx/vesta/security/dependabot/12) and GHSA-vhxv-fg4m-p2w8 (substring/suffix origin bugs).

## Rules

1. **Exact origin matching only.** Use an allowlist of full origin strings (e.g. `https://sona.vesta.example.com`). Never use:
   - `origin.endsWith()` / substring / suffix patterns (vulnerable: `https://evilvesta.example.com`)
   - Regex with overlapping matches
   - `*` in production for APIs that accept credentials or sensitive data

2. **Allowlist from env.** Configure allowed origins via environment variables (e.g. `CORS_ORIGINS` as comma-separated list). Default to empty or same-origin in development.

3. **Handle preflight.** Respond to `OPTIONS` with appropriate `Access-Control-*` headers before route handlers run.

4. **Per-app scope.** Each app (sona, euterpe, erato, etc.) declares its own CORS policy. Cross-app calls (e.g. sona â†’ euterpe) are server-to-server and do not use CORS.

## Implementation

- **SvelteKit (sona):** Add a `handle` in `hooks.server.ts` that injects CORS headers for `/api/*` (or all responses). Use `createCorsHandle` from `@vesta-cx/utils` or inline allowlist validation.
- **Hono (euterpe):** Use `cors()` middleware with `origin: allowedOrigins` (array of strings). Never use callback with `endsWith()`.

## Checklist for new apps

- [ ] CORS middleware/handle added
- [ ] Allowed origins from env
- [ ] OPTIONS preflight handled
- [ ] No wildcard `*` for credentialed requests
