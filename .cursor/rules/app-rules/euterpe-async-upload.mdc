---
description: Euterpe transcoding microservice and async upload flow
globs: apps/euterpe/**, apps/sona/src/routes/(app)/admin/sources/**, apps/sona/src/routes/api/transcode-status/**, apps/sona/src/routes/api/webhooks/euterpe-complete/**, apps/sona/src/lib/stores/upload-progress.ts
---

# Euterpe Async Upload Flow

**Euterpe** is a standalone Node.js microservice (Hono + ffmpeg) that transcodes audio uploads. **sona** (or any client) is the caller.

## Flow

1. Admin uploads raw FLAC via sona â†’ form POSTs to `uploadRawFlac` action
2. Server POSTs file + config to euterpe `POST /transcode` (Bearer auth)
3. Euterpe returns `202 { jobId }`, processes in background
4. Client polls `GET /api/transcode-status?jobId=x` (sona proxies to euterpe)
5. Euterpe calls webhook `POST /api/webhooks/euterpe-complete` with `source` and `candidates` payload

## Key Constraints

- **Storage is client-driven**: each transcode request includes `storage: { type, bucket, credentials }`. Euterpe never owns storage config.
- **Metadata is client-owned**: euterpe accepts only `filename` and `uploadPrefix`. sona stores metadata in `pending_euterpe_jobs` at submit; webhook looks up by jobId and persists.
