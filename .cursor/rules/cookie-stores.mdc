---
description: Cookie consent, settings stores, vendor-based consent model, and UI components
globs:
  - packages/utils/src/cookies/**
  - packages/ui/src/lib/components/utils/cookie-consent-*/**
  - "**/cookies/**"
---

# Cookie Stores (`@vesta-cx/utils/cookies`)

Client-side cookie utilities using nanostores + `@nanostores/persistent`.

## Consent model

Per-vendor granularity. `essential` (always true) and `preferences` are simple toggles. Analytics and advertising consent is per-vendor via `vendors: Record<string, VendorConsent>`.

- **`consentStore`** — `persistentAtom<CookieConsent>` with JSON encode/decode.
- **`setConsentCookie(category, key, value)`** — for `essential` / `preferences` categories.
- **`setVendorCookie(vendor, purpose, key, value)`** — checks `vendors[vendor]?.[purpose]` before setting. Cookie key: `{vendor}:{purpose}:{key}`.
- **`acceptAllVendors(ids)` / `rejectAllVendors()`** — bulk helpers for UI.
- **`hasConsented()`** — checks if localStorage key exists (dialog visibility).

## Settings store

- **`settingsStore`** — `persistentMap<UserSettings>`. Auto-applies `theme` → `data-theme`, `locale` → `<html lang>`, persists as `preferences:settings.*` cookies.

## UI components (`@vesta-cx/ui`)

- **`CookieConsentForm`** — Full form with vendor toggles. Uses `@container` queries to adapt between narrow (dialog) and wide (page) layouts.
- **`CookieConsentDialog`** — Bottom-right sticky card. Compact → Expanded → Hidden. No overlay/backdrop.

Both accept `vendors: VendorDefinition[]` — the app defines its vendor list.

## Cross-domain

Call `configureCookies({ domain: '.vesta.cx' })` at app startup. Sets `domain` on all cookies. `SameSite=None` auto-sets `Secure`.

## Gotchas

- `deleteCookie` uses `max-age=0` (not `expires` in the past) for broader compat.
- Browser-only module — guarded with `typeof document !== "undefined"`.
- `CookieConsent` no longer has an index signature — `persistentAtom` handles nested objects via JSON.
