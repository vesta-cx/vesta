---
description: Drizzle ORM + Cloudflare D1 patterns for SvelteKit
globs:
  - "**/server/db/**"
  - "**/drizzle.config.*"
---

# Drizzle + Cloudflare D1

## DB access pattern

Use a factory function that takes `platform`:

```ts
import { drizzle } from 'drizzle-orm/d1';
export const getDb = (platform: App.Platform) => drizzle(platform.env.DB, { schema });
```

**NOT** a module-level singleton. D1 binding comes from the request-scoped platform object.

## Schema conventions

- `text('id').primaryKey().$defaultFn(() => crypto.randomUUID())` for UUID PKs
- `integer('col', { mode: 'timestamp' })` for dates — D1 is SQLite, stores as integer epoch
- `text('col', { enum: [...] as const })` for enum-like text columns
- `text('col', { mode: 'json' }).$type<T>()` for flexible JSON columns
- Composite PKs: use `primaryKey({ columns: [table.colA, table.colB] })` in the table's third arg
- Export enum arrays as `const` tuples for runtime validation

## drizzle.config.ts

For D1, no `dbCredentials` needed — just `dialect: 'sqlite'` and the schema path. Generate migrations with `drizzle-kit generate`, apply with `wrangler d1 migrations apply`.

## Local dev

Use `vite dev` — `@sveltejs/adapter-cloudflare` uses `getPlatformProxy()` to emulate D1/R2 locally. Secrets go in `.dev.vars`.
